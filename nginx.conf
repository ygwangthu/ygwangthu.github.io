#user  nobody;
user root;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # ==========================
    #   合法搜索引擎白名单
    # ==========================
    map $http_user_agent $is_good_bot {
        default                     0;
        "~*Googlebot"               1;
        "~*Bingbot"                 1;
        "~*Slurp"                   1; # Yahoo
        "~*DuckDuckBot"             1;
        "~*Baiduspider"             1;
        "~*YandexBot"               1;
        "~*Sogou"                   1;
        "~*360Spider"               1;
        "~*Bytespider"              1; # ByteDance / TikTok
    }

    # ==========================
    #   已知恶意爬虫黑名单
    # ==========================
    map $http_user_agent $is_bad_bot {
        default                     0;
        "~*MJ12bot"                 1;
        "~*AhrefsBot"               1;
        "~*SemrushBot"              1;
        "~*DotBot"                  1;
        "~*DataForSeoBot"           1;
        "~*Scrapy"                  1;
        "~*python-requests"         1;
        "~*curl"                    1;
        "~*wget"                    1;
        "~*Go-http-client"          1;
        "~*l9explore"               1;
        "~*l9tcpid"                 1;
    }

    # ==========================
    #   是否需要拦截（判断结果）
    # ==========================
    map "$is_good_bot:$is_bad_bot" $block_bot {
        "1:0"   0;   # 白名单通过
        "0:0"   0;   # 普通用户通过
        default 1;   # 黑名单拦截
    }

    # ==========================
    #   可选防爆爬限速
    # ==========================
    limit_req_zone $binary_remote_addr zone=perip:10m rate=10r/s;

    # ==========================
    #   HTTP -> HTTPS 重定向
    # ==========================
    server {
        listen       80;
        server_name  www.yangangwang.com;
        return 301 https://www.yangangwang.com$request_uri;
        access_log off;
    }

    # 对非 www 域名同样重定向
    server {
        listen       80;
        listen       443 ssl;
        server_name  yangangwang.com;

        ssl_certificate      yangangwang.com.crt;
        ssl_certificate_key  yangangwang.com.key;

        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;
        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

        return 301 https://www.yangangwang.com$request_uri;
    }

    # ==========================
    #   主站 HTTPS 配置
    # ==========================
    server {
       listen       443 ssl;
       server_name  www.yangangwang.com;

       ssl_certificate      yangangwang.com.crt;
       ssl_certificate_key  yangangwang.com.key;

       ssl_session_cache    shared:SSL:1m;
       ssl_session_timeout  5m;
       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

       # 拦截恶意爬虫
       if ($block_bot) {
           return 444;
       }

       # robots.txt 允许爬虫访问
       location = /robots.txt {
           root   html;
       }

       # 主网页
       location / {
            limit_req zone=perip burst=20 nodelay;
            root   html;
            index  index.html index.htm;
       }

       # 模块资源路径
       location /modules/ {
            alias html/modules/;
       }

       # 安全响应头
       add_header X-Content-Type-Options nosniff;
       add_header X-Xss-header "1;mode=block";

       error_page   500 502 503 504  /50x.html;
       location = /50x.html {
            root   html;
       }
    }
}